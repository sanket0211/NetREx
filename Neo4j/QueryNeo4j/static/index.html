<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
    <title>Graph Database for Rice Genomic Network</title>
</head>

<body>
<div id="graph">
</div>
<div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="row">
            <div class="navbar-header col-sm-4 col-md-4 ">
                
            </div>
            <div class="navbar-header col-sm-8 col-md-8 ">
                <div class="logo-well">
                    
                </div>
                <div class="navbar-brand" >
                    <div class="brand">Graph Database for Rice Genomic Network</div>
                </div>
            </div>
        </div>
    </div>
</div>
        <div class="row">
            <div class="col-sm-6 col-md-6">
                <ul class="nav navbar-nav">
                    <li>
                        <form role="search" class="navbar-form" id="search">
                            <div class="form-group">
                                <!-- <input type="file" value="-1" placeholder="Search for Os Ids" class="form-control" name="search"> -->
                                <input type="file" id="csvFileInput" onchange="handleFiles(this.files,0)" 
                                accept=".csv">
                            </div>                                                                                                                                                                                                                                                                                                                  
                            
                        </form>
                    </li>
                </ul>
            </div>
            <div class="navbar-header col-sm-6 col-md-6">
                <ul class="nav navbar-nav">
                    <li>
                        <form role="search" class="navbar-form" id="search_neighbours">
                            <div class="form-group">
                                <input type="file" id="csvFileInput" onchange="handleFiles(this.files,1)" 
                                accept=".csv">
                            </div>
                            <!--<button class="btn btn-default" type="submit">Search</button>-->
                        </form>
                    </li>
                </ul>
            </div>
        </div>
<div class="row">
    <div class="col-md-6">
        <div class="panel panel-default">
            <div class="panel-heading">Search Results</div>
            <table id="results" class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>Os Ids</th>
                    <th>start_pos</th>
                    <th>end_pos</th>
                    <th>strand</th>
                    <th>chromosome no</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <div  class="col-md-6">
        <div  class="panel panel-default">
            <div class="panel-heading">Search Results</div>
            <table  id="results2" class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>Os Ids</th>
                    <th>start_pos</th>
                    <th>end_pos</th>
                    <th>strand</th>
                    <th>chromosome no</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>
<style type="text/css">
    .node { stroke: #222; stroke-width: 1.5px; }
    .node.actor { fill: #888; }
    .node.movie { fill: #BBB; }
    .link { stroke: #999; stroke-opacity: .6; stroke-width: 1px; }
</style>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script type="text/javascript">

	var flag;

    function handleFiles(files,y) {
    	flag=y;
    // Check for the various File API support.
        if (window.FileReader) {
            // FileReader are supported.
            getAsText(files[0]);
            //console.log(files[0]);
        } else {
            alert('FileReader are not supported in this browser.');
        }
    }

    function getAsText(fileToRead) {
        var reader = new FileReader();
        // Handle errors load
        reader.onload = loadHandler;
        reader.onerror = errorHandler;
        // Read file into memory as UTF-8      
        reader.readAsText(fileToRead);
    }

    function loadHandler(event) {
        var csv = event.target.result;
        //console.log(csv);
        processData(csv);             
    }

    function processData(csv) {
        var allTextLines = csv;
        /*var lines = [];
        while (allTextLines.length) {
            lines.push(allTextLines.shift().split(','));
        }*/
        console.log(allTextLines);
        if(flag==0){
        	console.log(flag);

        	search(allTextLines);
        }
        else if( flag==1){
        	console.log("hoe");
        	search2(allTextLines);	
        }
        //drawOutput(lines);
    }

    function search(query) {
            //var query=$("#search").find("input[name=search]").val();
            console.log(query);
            $.get("/search?q=" + encodeURIComponent(query),
                    function (data) {
                        var t = $("table#results tbody").empty();
                        if (!data || data.length == 0) return;
                        data.forEach(function (row) {
                            var n = row.n;
                            $("<tr><td class='movie'>" + n.name + "</td><td>" + n.start_position + "</td><td>" + n.end_position +"</td><td>" + n.strand + "</td><td>" + n.chromosome_no  +"</td></tr>").appendTo(t)
                                    .click(function() { })
                        });
                        //showMovie(data[0].n.name);
                    }, "json");
            return false;
        }

        function search2(query) {
            // var title=$("#search_neighbours").find("input[name=search]").val();
            $.get("/movie/" + encodeURIComponent(query),
                    function (data) {
                        var t = $("table#results2 tbody").empty();
                        if (!data || data.length == 0) return;
                        data.forEach(function (row) {
                            var n = row.n;
                            $("<tr><td class='movie'>" + n.name + "</td><td>" + n.start_position + "</td><td>" + n.end_position +"</td><td>" + n.strand + "</td><td>" + n.chromosome_no  +"</td></tr>").appendTo(t)
                                    .click(function() { })
                        });
                        //showMovie(data[0].n.name);
                    }, "json");
            return false;
        }


    function errorHandler(evt) {
        if(evt.target.error.name == "NotReadableError") {
            alert("Canno't read file !");
        }
    }

    function drawOutput(lines){
        //Clear previous data
        document.getElementById("output").innerHTML = "";
        var table = document.createElement("table");
        for (var i = 0; i < lines.length; i++) {
            var row = table.insertRow(-1);
            for (var j = 0; j < lines[i].length; j++) {
                var firstNameCell = row.insertCell(-1);
                firstNameCell.appendChild(document.createTextNode(lines[i][j]));
            }
        }
    document.getElementById("output").appendChild(table);
    }








    $(function () {
        function showMovie(title) {
            var title=$("#search_neighbours").find("input[name=search]").val();
            $.get("/movie/" + encodeURIComponent(title),
                    function (data) {
                        var t = $("table#results2 tbody").empty();
                        if (!data || data.length == 0) return;
                        data.forEach(function (row) {
                            var n = row.n;
                            $("<tr><td class='movie'>" + n.name + "</td><td>" + n.start_position + "</td><td>" + n.end_position +"</td><td>" + n.strand + "</td><td>" + n.chromosome_no  +"</td></tr>").appendTo(t)
                                    .click(function() { })
                        });
                        //showMovie(data[0].n.name);
                    }, "json");
            return false;
        }
        function search(query) {
            //var query=$("#search").find("input[name=search]").val();
            console.log(query);
            $.get("/search?q=" + encodeURIComponent(query),
                    function (data) {
                        var t = $("table#results tbody").empty();
                        if (!data || data.length == 0) return;
                        data.forEach(function (row) {
                            var n = row.n;
                            $("<tr><td class='movie'>" + n.name + "</td><td>" + n.start_position + "</td><td>" + n.end_position +"</td><td>" + n.strand + "</td><td>" + n.chromosome_no  +"</td></tr>").appendTo(t)
                                    .click(function() { })
                        });
                        //showMovie(data[0].n.name);
                    }, "json");
            return false;
        }

        function search2() {
            var query=$("#search_neighbours").find("input[name=search]").val();
            $.get("/search?q=" + encodeURIComponent(query),
                    function (data) {
                        var t = $("table#results tbody").empty();
                        if (!data || data.length == 0) return;
                        data.forEach(function (row) {
                            var n = row.n;
                            $("<tr><td class='movie'>" + n.name + "</td><td>" + n.start_position + "</td><td>" + n.end_position +"</td><td>" + n.strand + "</td><td>" + n.chromosome_no  +"</td></tr>").appendTo(t)
                                    .click(function() { showMovie($(this).find("td.movie").text());})
                        });
                        showMovie(data[0].n.name);
                    }, "json");
            return false;
        }
        function showSubGraph(title) {
            $.get("/subgraph/" + encodeURIComponent(title),
                    function (data) {
                        var t = $("table#results3 tbody").empty();
                        if (!data || data.length == 0) return;
                        data.forEach(function (row) {
                            var n = row.n;
                            $("<tr><td class='movie'>" + n.name + "</td><td>" + n.start_position + "</td><td>" + n.end_position +"</td><td>" + n.strand + "</td><td>" + n.chromosome_no  +"</td></tr>").appendTo(t)
                                    .click(function() { })
                        });
                        //showMovie(data[0].n.name);
                    }, "json");
            return false;
        }
        $("#search").submit(search);
        $("#search_neighbours").submit(showMovie);
        search();
        
    })
</script>

<script type="text/javascript">
    var width = 800, height = 800;

    var force = d3.layout.force()
            .charge(-200).linkDistance(30).size([width, height]);

    var svg = d3.select("#graph").append("svg")
            .attr("width", "100%").attr("height", "100%")
            .attr("pointer-events", "all");

    d3.json("/graph", function(error, graph) {
		if (error) return;
		
        force.nodes(graph.nodes).links(graph.links).start();

        var link = svg.selectAll(".link")
                .data(graph.links).enter()
                .append("line").attr("class", "link");

        var node = svg.selectAll(".node")
                .data(graph.nodes).enter()
                .append("circle")
                .attr("class", function (d) { return "node "+d.label })
                .attr("r", 10)
                .call(force.drag);

        // html title attribute
        node.append("title")
                .text(function (d) { return d.title; })

        // force feed algo ticks
        force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

            node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
        });
    });
</script>
</body>
</html>
